import { createClient } from '@supabase/supabase-js';
import dotenv from 'dotenv';
import { mockFeed, mockCloset, userProfile } from './mockDb.js';

// Load environment variables from .env
dotenv.config();

const supabaseUrl = process.env.VITE_SUPABASE_URL;
const supabaseKey = process.env.VITE_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey || supabaseUrl.includes('your_supabase')) {
    console.error("âŒ Please set real VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY in your .env file first.");
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function seedDatabase() {
    console.log("ðŸš€ Starting Database Seed...");

    // 1. You must be authenticated to insert data based on our RLS policies!
    // For a seeding script, you would usually use a Service Role Key, 
    // but since we only have the anon key, we need to create/login a dummy user first.
    console.log("ðŸ‘¤ Creating/Logging in a dummy user for seeding...");
    const testEmail = "testuser_vibecheck@example.com";
    const testPassword = "password123";

    let { data: authData, error: authError } = await supabase.auth.signUp({
        email: testEmail,
        password: testPassword,
    });

    if (authError && authError.message.includes('already registered')) {
        const loginRet = await supabase.auth.signInWithPassword({
            email: testEmail,
            password: testPassword,
        });
        authData = loginRet.data;
        authError = loginRet.error;
    }

    if (authError || !authData.user) {
        console.error("âŒ Failed to authenticate dummy user. Seeding cannot proceed:", authError);
        process.exit(1);
    }

    const userId = authData.user.id;
    console.log(`âœ… Authenticated as user ID: ${userId}`);

    // 2. Create the user's Profile
    console.log("ðŸ‘¤ Seeding Profile...");
    const { error: profileError } = await supabase
        .from('profiles')
        .upsert({
            id: userId,
            username: userProfile.username
        });
    if (profileError) console.error("Error seeding profile:", profileError);


    // 3. Seed Items (Closet)
    console.log("ðŸ‘• Seeding items...");
    // We need to map the old string IDs (i1, i2) to the new UUIDs generated by Supabase
    // so we can link them to posts later.
    const itemIdMap = {};

    // We will extract unique items from both mockCloset AND mockFeed to ensure we have everything
    const allUniqueItems = [...mockCloset];

    mockFeed.forEach(post => {
        post.items.forEach(feedItem => {
            if (!allUniqueItems.find(i => i.id === feedItem.id)) {
                allUniqueItems.push({
                    ...feedItem,
                    imageUrl: "https://images.unsplash.com/photo-1541099649105-f69ad21f3246?auto=format&fit=crop&q=80&w=400" // Fallback image if it was only in feed
                });
            }
        })
    });

    for (const item of allUniqueItems) {
        const { data, error } = await supabase
            .from('items')
            .insert({
                user_id: userId,
                name: item.name,
                category: item.category,
                image_url: item.imageUrl,
                is_owned: item.isOwned !== false // default true unless explicitly false
            })
            .select('id')
            .single();

        if (error) {
            console.error(`Error inserting item ${item.name}:`, error.message);
        } else {
            itemIdMap[item.id] = data.id; // Map old "i1" to new UUID
        }
    }


    // 4. Seed Feed Posts and Relationships
    console.log("ðŸ“¸ Seeding feed posts and relationships...");
    for (const post of mockFeed) {
        // Insert the post
        const { data: postData, error: postError } = await supabase
            .from('feed_posts')
            .insert({
                user_id: userId,
                image_url: post.imageUrl,
                niche: post.niche,
                engagement_count: parseInt(post.engagementCount) * 1000 || 0
            })
            .select('id')
            .single();

        if (postError) {
            console.error(`Error inserting post:`, postError.message);
            continue;
        }

        const newPostId = postData.id;

        // Insert the item relationships (post_items)
        if (post.items && post.items.length > 0) {
            const postItemsToInsert = post.items.map(mappedItem => ({
                post_id: newPostId,
                item_id: itemIdMap[mappedItem.id]
            })).filter(mapping => mapping.item_id); // Filter out any that failed to map

            if (postItemsToInsert.length > 0) {
                const { error: piError } = await supabase.from('post_items').insert(postItemsToInsert);
                if (piError) console.error(`Error mapping items to post ${newPostId}:`, piError.message);
            }
        }

        // Insert Try-on Callouts
        if (post.tryOnCallouts && post.tryOnCallouts.length > 0) {
            const calloutsToInsert = post.tryOnCallouts.map(c => ({
                post_id: newPostId,
                top_position: c.top,
                left_position: c.left,
                text: c.text
            }));
            const { error: cError } = await supabase.from('try_on_callouts').insert(calloutsToInsert);
            if (cError) console.error(`Error inserting callouts for post ${newPostId}:`, cError.message);
        }
    }

    console.log("ðŸŽ‰ Seeding complete! Your Supabase database is now populated.");
}

seedDatabase();
